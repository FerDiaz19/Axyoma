#!/usr/bin/env python
"""
Script para crear datos iniciales del sistema Axyoma
Crea usuarios, empresa, plantas, departamentos, puestos y planes de suscripci√≥n
"""

import os
import sys
import django
from django.db import transaction

# Configurar Django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings.local')
django.setup()

from django.contrib.auth.models import User
from apps.models import (
    Empresa, Usuario, Planta, Departamento, Puesto, 
    PlanSuscripcion, Suscripcion, Empleado, AdminPlanta
)
from datetime import datetime, timedelta

def create_initial_data():
    """Crear todos los datos iniciales del sistema"""
    
    print("üöÄ Iniciando creaci√≥n de datos iniciales...")
    
    with transaction.atomic():
        # 1. Crear Planes de Suscripci√≥n
        print("üìã Creando planes de suscripci√≥n...")
        
        plan_basico, created = PlanSuscripcion.objects.get_or_create(
            nombre="B√°sico",
            defaults={
                'descripcion': 'Plan b√°sico para empresas peque√±as',
                'duracion': 30,
                'precio': 499.00,
                'status': True
            }
        )
        
        plan_profesional, created = PlanSuscripcion.objects.get_or_create(
            nombre="Profesional",
            defaults={
                'descripcion': 'Plan profesional para empresas medianas',
                'duracion': 30,
                'precio': 999.00,
                'status': True
            }
        )
        
        plan_empresarial, created = PlanSuscripcion.objects.get_or_create(
            nombre="Empresarial",
            defaults={
                'descripcion': 'Plan empresarial para grandes corporaciones',
                'duracion': 30,
                'precio': 1999.00,
                'status': True
            }
        )
        
        print(f"   ‚úÖ Creados 3 planes de suscripci√≥n")
        
        # 2. Crear Usuario SuperAdmin
        print("üë§ Creando SuperAdmin...")
        
        # Usuario Django para SuperAdmin
        superadmin_user, created = User.objects.get_or_create(
            username='superadmin',
            defaults={
                'email': 'ed-rubio@axyoma.com',
                'first_name': 'Eduardo',
                'last_name': 'Rubio',
                'is_staff': True,
                'is_superuser': True
            }
        )
        if created:
            superadmin_user.set_password('1234')
            superadmin_user.save()
        
        # Usuario Axyoma para SuperAdmin
        superadmin_usuario, created = Usuario.objects.get_or_create(
            correo='ed-rubio@axyoma.com',
            defaults={
                'nombre': 'Eduardo',
                'apellido_paterno': 'Rubio',
                'apellido_materno': 'Gonz√°lez',
                'nivel_usuario': 'superadmin',
                'status': True,
                'user': superadmin_user
            }
        )
        
        print(f"   ‚úÖ SuperAdmin creado: {superadmin_usuario.correo}")
          # 3. Crear Admin Empresa (temporalmente sin empresa)
        print("üë§ Creando Admin Empresa...")
        
        admin_empresa_user, created = User.objects.get_or_create(
            username='admin_empresa',
            defaults={
                'email': 'juan.perez@codewave.com',
                'first_name': 'Juan',
                'last_name': 'P√©rez',
                'is_staff': False,
                'is_superuser': False
            }
        )
        if created:
            admin_empresa_user.set_password('1234')
            admin_empresa_user.save()

        admin_empresa, created = Usuario.objects.get_or_create(
            correo='juan.perez@codewave.com',
            defaults={
                'nombre': 'Juan',
                'apellido_paterno': 'P√©rez',
                'apellido_materno': 'L√≥pez',
                'nivel_usuario': 'admin-empresa',
                'status': True,
                'user': admin_empresa_user
            }
        )
        
        print(f"   ‚úÖ Admin Empresa creado: {admin_empresa.correo}")

        # 4. Crear Empresa de prueba
        print("üè¢ Creando empresa de prueba...")
        
        empresa, created = Empresa.objects.get_or_create(
            rfc='CWT240701ABC',
            defaults={
                'nombre': 'CodeWave Technologies',
                'direccion': 'Av. Revoluci√≥n 1234, Col. San √Ångel, CDMX',
                'email_contacto': 'contacto@codewave.com',
                'telefono_contacto': '+525598765432',
                'status': True,
                'administrador': admin_empresa
            }
        )
        
        print(f"   ‚úÖ Empresa creada: {empresa.nombre}")

        # 5. Crear Suscripci√≥n para la empresa
        print("üí≥ Creando suscripci√≥n...")
        
        suscripcion, created = Suscripcion.objects.get_or_create(
            empresa=empresa,
            defaults={
                'plan_suscripcion': plan_profesional,
                'fecha_inicio': datetime.now().date(),
                'fecha_fin': (datetime.now() + timedelta(days=365)).date(),
                'estado': 'Activa',
                'status': True
            }
        )
        
        print(f"   ‚úÖ Suscripci√≥n creada: Plan {suscripcion.plan_suscripcion.nombre}")

        # 6. Crear Planta Principal de la empresa (autom√°tica al registrarse)
        print("üè≠ Creando planta principal de la empresa...")
        
        planta_principal, created = Planta.objects.get_or_create(
            nombre='Planta Principal',
            empresa=empresa,
            defaults={
                'direccion': 'Av. Revoluci√≥n 1234, Col. San √Ångel, CDMX',  # Misma direcci√≥n que la empresa inicialmente
                'status': True
            }
        )
        
        print(f"   ‚úÖ Planta Principal creada: {planta_principal.nombre} (planta donde contrat√≥ el servicio)")
        
        # 7. Crear Departamentos en la Planta Principal
        print("üè¢ Creando departamentos en la planta principal...")
        
        departamentos_data = [
            # Departamentos administrativos
            {'nombre': 'Administraci√≥n', 'descripcion': 'Gesti√≥n administrativa general'},
            {'nombre': 'Recursos Humanos', 'descripcion': 'Gesti√≥n del personal y n√≥mina'},
            {'nombre': 'Finanzas', 'descripcion': 'Gesti√≥n financiera y contable'},
            # Departamentos operativos
            {'nombre': 'Producci√≥n', 'descripcion': 'Operaciones de manufactura'},
            {'nombre': 'Calidad', 'descripcion': 'Control y aseguramiento de calidad'},
            {'nombre': 'Mantenimiento', 'descripcion': 'Mantenimiento de equipos e instalaciones'},
            {'nombre': 'Log√≠stica', 'descripcion': 'Almac√©n y distribuci√≥n'},
        ]
        
        departamentos = []
        for dept_data in departamentos_data:
            dept, created = Departamento.objects.get_or_create(
                nombre=dept_data['nombre'],
                planta=planta_principal,
                defaults={
                    'descripcion': dept_data['descripcion']
                }
            )
            departamentos.append(dept)
        
        print(f"   ‚úÖ Creados {len(departamentos)} departamentos en la planta principal")
        
        # 8. Crear Puestos para todos los departamentos
        print("üíº Creando puestos...")
        
        puestos_data = [
            # Administraci√≥n
            {'nombre': 'Gerente General', 'departamento': 'Administraci√≥n'},
            {'nombre': 'Asistente Administrativo', 'departamento': 'Administraci√≥n'},
            
            # Recursos Humanos
            {'nombre': 'Gerente de RRHH', 'departamento': 'Recursos Humanos'},
            {'nombre': 'Especialista en N√≥mina', 'departamento': 'Recursos Humanos'},
            {'nombre': 'Reclutador', 'departamento': 'Recursos Humanos'},
            
            # Finanzas
            {'nombre': 'Contador', 'departamento': 'Finanzas'},
            {'nombre': 'Analista Financiero', 'departamento': 'Finanzas'},
            
            # Producci√≥n
            {'nombre': 'Supervisor de Producci√≥n', 'departamento': 'Producci√≥n'},
            {'nombre': 'Operador de M√°quina', 'departamento': 'Producci√≥n'},
            {'nombre': 'T√©cnico de Proceso', 'departamento': 'Producci√≥n'},
            
            # Calidad
            {'nombre': 'Inspector de Calidad', 'departamento': 'Calidad'},
            {'nombre': 'Auditor Interno', 'departamento': 'Calidad'},
            
            # Mantenimiento
            {'nombre': 'T√©cnico de Mantenimiento', 'departamento': 'Mantenimiento'},
            {'nombre': 'Electricista Industrial', 'departamento': 'Mantenimiento'},
            
            # Log√≠stica
            {'nombre': 'Coordinador de Almac√©n', 'departamento': 'Log√≠stica'},
            {'nombre': 'Montacarguista', 'departamento': 'Log√≠stica'},
        ]
        
        puestos = []
        for puesto_data in puestos_data:
            dept = next((d for d in departamentos if d.nombre == puesto_data['departamento']), None)
            if dept:
                puesto, created = Puesto.objects.get_or_create(
                    nombre=puesto_data['nombre'],
                    departamento=dept
                )
                puestos.append(puesto)
        
        print(f"   ‚úÖ Creados {len(puestos)} puestos en la planta principal")
        
        # 9. Crear Usuario Admin Planta
        print("üë§ Creando Admin Planta...")
        
        admin_planta_user, created = User.objects.get_or_create(
            username='admin_planta',
            defaults={
                'email': 'maria.gomez@codewave.com',
                'first_name': 'Mar√≠a',
                'last_name': 'G√≥mez',
                'is_staff': False,
                'is_superuser': False
            }
        )
        if created:
            admin_planta_user.set_password('1234')
            admin_planta_user.save()
        
        admin_planta, created = Usuario.objects.get_or_create(
            correo='maria.gomez@codewave.com',
            defaults={
                'nombre': 'Mar√≠a',
                'apellido_paterno': 'G√≥mez',
                'apellido_materno': 'Rodr√≠guez',
                'nivel_usuario': 'admin-planta',
                'status': True,
                'user': admin_planta_user
            }
        )
        
        # Asignar la planta al admin_planta usando la tabla intermedia
        admin_planta_asignacion, created = AdminPlanta.objects.get_or_create(
            usuario=admin_planta,
            planta=planta_principal,
            defaults={
                'status': True
            }
        )
        
        print(f"   ‚úÖ Admin Planta creado: {admin_planta.correo} - Planta: {planta_principal.nombre}")
        
        # 10. Crear empleados de muestra
        print("üë• Creando empleados de muestra...")
        
        empleados_data = [
            # Empleados administrativos
            {'nombre': 'Laura', 'apellido_paterno': 'Jim√©nez', 'apellido_materno': 'Ruiz', 'genero': 'Femenino', 'puesto': 'Especialista en N√≥mina', 'antiguedad': 2},
            {'nombre': 'Pedro', 'apellido_paterno': 'Gonz√°lez', 'apellido_materno': 'Morales', 'genero': 'Masculino', 'puesto': 'Contador', 'antiguedad': 4},
            
            # Empleados operativos
            {'nombre': 'Carlos', 'apellido_paterno': 'Mart√≠nez', 'apellido_materno': 'S√°nchez', 'genero': 'Masculino', 'puesto': 'Supervisor de Producci√≥n', 'antiguedad': 5},
            {'nombre': 'Ana', 'apellido_paterno': 'L√≥pez', 'apellido_materno': 'Garc√≠a', 'genero': 'Femenino', 'puesto': 'Inspector de Calidad', 'antiguedad': 3},
            {'nombre': 'Roberto', 'apellido_paterno': 'Hern√°ndez', 'apellido_materno': 'Morales', 'genero': 'Masculino', 'puesto': 'T√©cnico de Mantenimiento', 'antiguedad': 7},
            {'nombre': 'Diego', 'apellido_paterno': 'Vargas', 'apellido_materno': 'Castro', 'genero': 'Masculino', 'puesto': 'Operador de M√°quina', 'antiguedad': 4},
        ]
        
        empleados_creados = 0
        for emp_data in empleados_data:
            puesto = next((p for p in puestos if p.nombre == emp_data['puesto']), None)
            if puesto:
                empleado, created = Empleado.objects.get_or_create(
                    nombre=emp_data['nombre'],
                    apellido_paterno=emp_data['apellido_paterno'],
                    planta=planta_principal,
                    defaults={
                        'apellido_materno': emp_data['apellido_materno'],
                        'genero': emp_data['genero'],
                        'antiguedad': emp_data['antiguedad'],
                        'puesto': puesto,
                        'departamento': puesto.departamento,
                        'status': True
                    }
                )
                if created:
                    empleados_creados += 1
        
        print(f"   ‚úÖ Creados {empleados_creados} empleados en la planta principal")
    
    print("\nüéâ ¬°DATOS INICIALES CREADOS EXITOSAMENTE!")
    print("\nüìä RESUMEN:")
    print(f"   ‚úÖ {PlanSuscripcion.objects.count()} planes de suscripci√≥n")
    print(f"   ‚úÖ {Usuario.objects.count()} usuarios del sistema")
    print(f"   ‚úÖ {Empresa.objects.count()} empresa")
    print(f"   ‚úÖ {Planta.objects.count()} planta principal (autom√°tica al registrarse)")
    print(f"   ‚úÖ {AdminPlanta.objects.count()} asignaciones admin-planta")
    print(f"   ‚úÖ {Departamento.objects.count()} departamentos")
    print(f"   ‚úÖ {Puesto.objects.count()} puestos")
    print(f"   ‚úÖ {Empleado.objects.count()} empleados")
    print(f"   ‚úÖ {Suscripcion.objects.count()} suscripci√≥n activa")
    
    print("\nüë§ USUARIOS CREADOS:")
    print("   üîë SuperAdmin:     ed-rubio@axyoma.com / 1234")
    print("   üè¢ Admin Empresa:  juan.perez@codewave.com / 1234")
    print("   üè≠ Admin Planta:   maria.gomez@codewave.com / 1234")
    
    print("\nüè¢ EMPRESA CREADA:")
    print("   üìã Nombre: CodeWave Technologies S.A. de C.V.")
    print("   üìÑ RFC: CWT240701ABC")
    print("   üè≠ Planta Principal: Creada autom√°ticamente al registrarse")
    print("   üí≥ Plan: Profesional (activo)")
    print("   üìù Nota: Puede crear plantas adicionales desde 'Gesti√≥n de Plantas'")
    
    return True

if __name__ == '__main__':
    try:
        success = create_initial_data()
        if success:
            print("\n‚úÖ Proceso completado exitosamente")
            sys.exit(0)
        else:
            print("\n‚ùå Error en el proceso")
            sys.exit(1)
    except Exception as e:
        print(f"\n‚ùå Error: {str(e)}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
